---
title: "Draft"
author: "Anna Ma"
date: "12/4/2021"
output: html_document
---

```{r include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom",plot.title = element_text(face = "bold")))
```

## Load data

```{r}
data_hist = 
  read_csv("data/NYPD_Shooting_Incident_Data__Historic_.csv") %>%
  janitor::clean_names() %>%
  rename("date" = "occur_date",
         "time" = "occur_time") %>%
  separate(date, into = c("month", "day", "year"), sep = "/") %>%
  separate(time, into = c("hour", "minute"), sep = ":") %>% 
  mutate(
          boro = str_to_lower(boro),
          location_desc = str_to_lower(location_desc),
          perp_race = str_to_lower(perp_race),
          vic_race = str_to_lower(vic_race),
          perp_age_group = str_replace(perp_age_group, "UNKNOWN","unknown"),
          perp_sex = recode(perp_sex, "M" = "male","F" = "female","U" = "unknown"), 
          vic_sex = recode(vic_sex, "M" = "male","F" = "female","U" = "unknown"),
          jurisdiction_code = case_when(
            jurisdiction_code == 0 ~ "patrol", 
            jurisdiction_code == 1 ~ "transit",
            jurisdiction_code == 2 ~ "housing")
          ) %>% 
  arrange(year,month,day,hour,minute)
```

## Map with leaflet 

Map all the shooting incidents on the map. The red dots denote incidents where the victims are killed, whereas the navy dots denote incidents where the victims survived. If click on the marker, it displays the time and date when the incidents occured.

```{r}
library(leaflet)
```

```{r}
pal <- colorFactor(c("red", "navy"), domain = c("murdered", "survived"))


data_map = 
  data_hist %>% 
  mutate(
    date_paste = as.Date(paste(year,month,day,sep = "-")),
    time_paste = paste(hour,minute,sep = ":"),
    statistical_murder_flag = case_when(
      statistical_murder_flag == "TRUE" ~"murdered",
      statistical_murder_flag == "FALSE" ~"survived"
    )) %>% 
  rename("lat" = "latitude",
         "lng" = "longitude") %>%
  select(date_paste,time_paste, statistical_murder_flag, lat,lng)
  

data_map %>% 
  mutate(
    label = str_c("<b>date: ", date_paste, "</b><br>time: ", time_paste , sep = "") ) %>%
  leaflet() %>% 
  addTiles() %>%
  addProviderTiles(providers$CartoDB.Positron) %>% 
  addLegend("bottomright", pal = pal, values = ~statistical_murder_flag,
    title = "statistical_murder_flag",
    opacity = 1
  ) %>% 
  addCircleMarkers(
     lng = ~lng,
     lat = ~lat,
    color = ~pal(statistical_murder_flag),
    fillOpacity = 0.5,
    radius = 0.5,
    popup = ~ label) 
```

```{r}
data_hist %>% 
  filter(year == 2015) %>%
  filter(boro == "manhattan") %>% 
  filter(hour >= 00 & hour <= 03) %>% 
  group_by(hour) %>% 
  summarise(n_obs=n()) %>% 
  ggplot(aes(x = hour,y = n_obs)) + 
  geom_point()
```

```{r}
data = read_csv("data/NYPD_Shooting_Incident_Data_Clean.csv") %>% 
  filter(year >= 2010) %>% 
  group_by(year) %>% 
  summarise(n_obs = n())

data_unem = read_csv("data/unemployment/unemployed_complete.csv") %>% select(-...1) %>% group_by(year) %>% summarise(m=mean(unemployment_rate))

data_ana = left_join(data,data_unem, by = c("year")) %>% mutate(m = m*100)

unemployment = "sienna2"
total_incident = "steelblue2"

data_ana %>% 
  ggplot() +
  geom_line(mapping = aes(x = year,y = n_obs), color = "steelblue2")+
  geom_line(mapping = aes(x = year,y = m*200), color = "sienna2")+
  scale_x_continuous(limits = c(2010, 2020), breaks = seq(2010, 2020, by = 1))+
  scale_y_continuous(
    # First axis
    name = "Total Number of Incidents",
    # Add a second axis and specify its features
    sec.axis = sec_axis(trans = ~ ./200,name = "Unemployment Rate (%)")
  ) +
  geom_text(x = 2013, y = 1000, label = "Unemployment Rate (%)", color = "sienna2") + 
geom_text(x = 2016, y = 1500, label = "Total Incident", color = "steelblue2")+
  theme(
    axis.title.y = element_text(color = "steelblue2"),
    axis.title.y.right = element_text(color = "sienna2")
  )

```

```{r}
data_hm = read_csv("data/NYPD_Shooting_Incident_Data_Clean.csv") %>% 
  filter(year == 2020) %>%
  plot_ly(
    lon = ~longitude, 
    lat = ~latitude,  
    type = 'densitymapbox',
    radius = 3) %>% 
  layout(
    mapbox = 
      list(
        style = 'open-street-map',
        zoom = 9,
        center = list(lat = 40.71, lon = -73.97)),
      title = "Density Heatmap of Shooting Incident in 2020")
data_hm

```

```{r}
nyc =
  parking %>%
  drop_na(long, lat) %>%
  summarise(
    lon_max = max(long),
    lon_min = min(long),
    lat_max = max(lat),
    lat_min = min(lat)
  )
nyc =
  ggmap::get_map(location = c(
    right = pull(nyc, lon_max),
    left = pull(nyc, lon_min),
    top = pull(nyc, lat_max),
    bottom = pull(nyc, lat_min)
  ))
set.seed(100)
read_csv(here::here("data/parking_vio2021_cleanv1.csv")) %>%
  drop_na(address) %>% 
  filter(hour != 12.3) %>%
  filter(hour <= 24) %>%
  drop_na(borough,lat,long,hour) %>% 
  sample_n(1e+5) %>% 
  mutate(text_label = str_c("borough:", borough, ",address:", address)) %>% 
  plot_ly()  %>% 
    add_markers(
    y = ~ lat,
    x = ~ long,
    text = ~ text_label,
    alpha = 0.02,
    frame = ~ hour,
    mode = "marker",
    color = ~borough,
    colors = viridis::viridis(4,option = "C")
  ) %>%
  layout(
    images = list(
      source = raster2uri(nyc),
      xref = "x",
      yref = "y",
      y = 40.5,
      x = -74.28	,
      sizey = 0.4,
      sizex = 0.58,
      sizing = "stretch",
      xanchor = "left",
      yanchor = "bottom",
      opacity = 0.4,
      layer = "below"
    )
  )%>%
  animation_opts(transition = 0,frame = 24)
```

# Education
```{r}
education_plot = 
  educational %>%
  ggplot(aes(x = year, y = percent, color = boro)) + scale_x_continuous(breaks = seq(2010, 2020, by = 1)) +
  geom_line() +
  labs(
    title = "Education", 
    x =  "Year",
    y = "Percentage of adults with high school education or higher") 

education_plot
```

 
This plot shows the percentage change in each borough over the year that every person over 18 with high school education or above. All borough have the upward trend in last 10 years. However, brooklyn the one with most shooting incident borough has a notability increase slope in 2015, which matched our forecast about the association with age group and education. We conclude that when education increase, the shooting incident decrease.